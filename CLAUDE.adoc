= CLAUDE.adoc
:toc: left
:toclevels: 2

== Project Overview

*recon-silly-ation* - Documentation Reconciliation System

A Deno/ReScript-based system with WASM acceleration that automatically reconciles, deduplicates, and resolves conflicts in Git repository documentation (README, LICENSE, SECURITY, etc.). Uses content-addressable storage with ArangoDB graph database and automatic conflict resolution based on confidence scoring.

This document provides context for Claude (AI assistant) when working on this codebase.

== Technology Stack (Updated)

* *Deno* - Secure TypeScript/JavaScript runtime (replaced npm/Node.js)
* *ReScript* - Type-safe functional programming
* *Rust/WASM* - High-performance WebAssembly modules (2-5x faster)
* *ArangoDB* - Multi-model graph database
* *Haskell* - Schema validation bridge
* *Podman* - Rootless container runtime (replaced Docker)
* *AsciiDoc* - Documentation format (replaced most Markdown)

== Project Structure

[source]
----
recon-silly-ation/
├── src/                          # TypeScript/ReScript source
│   ├── main.ts                   # Deno entry point
│   ├── wasm/                     # WASM module loader
│   │   └── mod.ts                # WASM initialization
│   ├── Types.res                 # Core domain types
│   ├── Deduplicator.res          # Content-addressable deduplication
│   ├── ConflictResolver.res      # Rule-based conflict resolution
│   ├── ArangoClient.res          # Type-safe database client
│   ├── Pipeline.res              # Idempotent orchestration
│   ├── CLI.res                   # Command-line interface
│   ├── LLMIntegration.res        # LLM integration with guardrails
│   ├── LogicEngine.res           # miniKanren/Datalog inference
│   ├── CCCPCompliance.res        # Python detection & migration
│   ├── HaskellBridge.res         # Bridge to Haskell validator
│   └── GraphVisualizer.res       # DOT/Mermaid visualization
├── wasm-modules/                 # Rust WASM source
│   ├── Cargo.toml                # Rust project config
│   └── src/lib.rs                # Hash + normalization in Rust
├── validator/                    # Haskell schema validator
│   ├── DocumentValidator.hs      # Validation logic
│   ├── Main.hs                   # CLI entry point
│   └── validator-bridge.cabal
├── tests/                        # Test suite
│   └── TestRunner.res            # Comprehensive tests
├── docs/                         # Documentation (AsciiDoc)
│   ├── doc-reconciliation-architecture.adoc
│   ├── IMPLEMENTATION-SUMMARY.adoc
│   ├── RSR-COMPLIANCE-AUDIT.adoc # RSR compliance tracking
│   └── TPCF.adoc                 # Governance framework
├── scripts/                      # Build and verification
│   ├── build-wasm.ts             # WASM compilation
│   └── verify-rsr-compliance.ts  # RSR compliance checker
├── .well-known/                  # RFC standards
│   ├── security.txt              # RFC 9116 security contact
│   ├── ai.txt                    # AI training policy
│   └── humans.txt                # Team attribution
├── .github/workflows/            # CI/CD
│   └── ci.yml                    # GitHub Actions (Deno)
├── Containerfile                 # Podman multi-stage build
├── podman-compose.yml            # Stack deployment
├── justfile                      # Build automation
├── flake.nix                     # Nix reproducibility
├── deno.json                     # Deno configuration
├── bsconfig.json                 # ReScript configuration
├── LICENSE.txt                   # Dual MIT + Palimpsest v0.8
├── CONTRIBUTING.adoc             # Contribution guidelines
├── CODE_OF_CONDUCT.md            # Community standards
├── MAINTAINERS.md                # Project governance
├── CHANGELOG.adoc                # Version history
└── CLAUDE.adoc                   # This file
----

== Getting Started

=== Prerequisites

* Deno 1.37+ - https://deno.land/
* Rust 1.70+ (for WASM) - https://rustup.rs/
* ArangoDB 3.11+ (optional, for persistence)
* Podman 4.0+ (for containers)
* GHC 9.2+ (optional, for Haskell validator)
* Just (optional, for build automation) - https://just.systems/

=== Installation

[source,bash]
----
# Clone repository
git clone https://github.com/Hyperpolymath/recon-silly-ation.git
cd recon-silly-ation

# Install Deno (if not already installed)
curl -fsSL https://deno.land/install.sh | sh

# Build WASM modules
deno task build:wasm

# Build ReScript code
deno task build
----

=== Running the Project

[source,bash]
----
# Basic usage - scan a repository
deno run --allow-all src/main.ts scan --repo /path/to/repo

# Using just
just scan /path/to/repo

# With Podman
podman-compose up

# Run tests
deno task test

# AOT compilation
deno task compile:aot
./bin/recon-silly-ation-aot scan --repo /path/to/repo
----

== Development Guidelines

=== Code Style

* *ReScript*: Follow ReScript best practices
* Use Belt standard library for functional operations
* Pattern match exhaustively (compiler enforced)
* Prefer immutable data structures
* Keep functions pure where possible
* *Deno*: Use Deno standard library (`@std/`)
* *Rust/WASM*: Optimize for size (opt-level = "z")

=== Testing

[source,bash]
----
# Run tests before committing
deno task test

# Or with just
just test

# Run CI checks locally
just ci
----

* Add tests for new features in `tests/`
* Ensure all tests pass before pushing
* Test suite runs automatically in CI

=== Git Workflow

* Work on feature branches
* Write clear, descriptive commit messages (Conventional Commits)
* Keep commits atomic and focused
* Rebase on main branch before merging

== Architecture

=== Core Principles

1. *Type Safety* - ReScript provides compile-time guarantees
2. *Memory Safety* - Rust ownership model for WASM
3. *Idempotency* - All pipeline stages can be rerun safely
4. *Content-Addressable* - SHA-256 hashing for deduplication
5. *Confidence Scoring* - Quantified resolution certainty (0.0-1.0)
6. *Auto-Resolution* - High confidence (>0.9) resolves automatically
7. *Offline-First* - Can work without network access
8. *WASM Performance* - 2-5x faster for critical operations

=== Pipeline Stages

[source]
----
Scan → Normalize → Deduplicate → Detect → Resolve → Ingest → Report
----

Each stage is *idempotent* and rerunnable.

=== Data Flow

1. *Scanner* finds documentation files
2. *Deduplicator* hashes content (WASM-accelerated), removes duplicates
3. *Conflict Detector* identifies conflicts
4. *Resolver* applies rules, generates resolutions
5. *ArangoDB Client* stores documents and relationships
6. *Reporter* generates summary

== Key Files and Directories

* *src/main.ts* - Deno entry point, CLI argument parsing
* *src/wasm/mod.ts* - WASM module loader with fallback
* *wasm-modules/src/lib.rs* - Rust hash + normalization (2-3x faster)
* *src/Types.res* - Complete type system, core domain model
* *src/Pipeline.res* - Orchestration logic, main entry point
* *src/ConflictResolver.res* - 6 built-in resolution rules
* *src/Deduplicator.res* - SHA-256 hashing, normalization
* *src/ArangoClient.res* - Database operations, graph queries
* *deno.json* - Deno configuration, task definitions
* *justfile* - Build automation with 25+ recipes
* *flake.nix* - Nix reproducibility (RSR requirement)
* *Containerfile* - Multi-stage Podman build (Rust + Haskell + Deno)
* *docs/RSR-COMPLIANCE-AUDIT.adoc* - Compliance tracking
* *scripts/verify-rsr-compliance.ts* - Automated compliance verification

== RSR Compliance

This project follows the *Rhodium Standard Repository (RSR)* framework.

*Current Status*: Silver Tier (Target: 80%+)

=== RSR Categories

1. *Documentation* - README.adoc, CONTRIBUTING.adoc, CHANGELOG.adoc, etc.
2. *Security* - .well-known/security.txt (RFC 9116), SECURITY.md
3. *Licensing* - Dual MIT + Palimpsest v0.8
4. *Build Reproducibility* - flake.nix, justfile, Containerfile
5. *Testing* - tests/, .github/workflows/ci.yml
6. *Community Governance* - CODE_OF_CONDUCT.md, MAINTAINERS.md, TPCF.adoc
7. *Offline-First* - Documented in README.adoc
8. *Type Safety* - ReScript + Haskell + Rust
9. *Memory Safety* - Rust ownership model
10. *Attribution* - .well-known/humans.txt
11. *AI Training Policy* - .well-known/ai.txt

=== TPCF Governance

This project operates under *TPCF Perimeter 3 (Community Sandbox)*:

* Open contribution model
* Graduated trust system
* Emotional safety principles (CCCP)
* Reversibility culture
* Learning from mistakes

See link:docs/TPCF.adoc[] for details.

=== Verify Compliance

[source,bash]
----
deno run --allow-read scripts/verify-rsr-compliance.ts
----

== Common Tasks

=== Adding a New Resolution Rule

1. Edit `src/ConflictResolver.res`
2. Add rule to `builtInRules` array
3. Specify priority and confidence
4. Implement `applies` and `resolve` functions
5. Add test in `tests/TestRunner.res`

=== Adding a New Document Type

1. Edit `src/Types.res`
2. Add variant to `documentType` enum
3. Update `documentTypeToString` and `documentTypeFromString`
4. Add detection logic in `Pipeline.scanRepository`
5. Optionally add validation in `validator/DocumentValidator.hs`

=== Extending LLM Integration

1. Edit `src/LLMIntegration.res`
2. Add new prompt type to `llmPromptType`
3. Create prompt template function
4. *CRITICAL*: Ensure `requiresApproval: true`
5. Add validation logic
6. Update audit trail

=== Building WASM Modules

[source,bash]
----
# Build Rust to WASM
deno task build:wasm

# Manual build
cd wasm-modules
cargo build --release --target wasm32-unknown-unknown
cp target/wasm32-unknown-unknown/release/recon_wasm.wasm ../src/wasm/hasher.wasm
----

=== Debugging

* Check Deno cache: `deno cache src/main.ts`
* View ReScript compilation: `deno task build`
* View generated JS: `lib/js/src/*.bs.js`
* Enable verbose logging in Pipeline
* Use ArangoDB web UI: http://localhost:8529
* Check Podman logs: `podman-compose logs -f`

== Dependencies

=== Deno Dependencies (deno.json)

* `@std/*` - Deno standard library
* `arangojs` (npm:arangojs@8.8.1) - ArangoDB client

=== Rust Dependencies (Cargo.toml)

* `sha2` - SHA-256 hashing
* `wasm-bindgen` - WASM bindings

=== ReScript Dependencies

* `rescript` (^11.0.1) - ReScript compiler
* `@rescript/core` (^1.5.0) - Standard library

=== Development Tools

* `just` - Build automation
* `podman` - Containerization
* `ghc/cabal` - Haskell compiler (for validator)

== Environment Variables

[source,bash]
----
# ArangoDB connection
ARANGO_URL=http://localhost:8529
ARANGO_DATABASE=reconciliation
ARANGO_USERNAME=root
ARANGO_PASSWORD=<secret>

# LLM integration (optional)
ANTHROPIC_API_KEY=<key>
OPENAI_API_KEY=<key>

# Validation (optional)
VALIDATOR_PATH=/usr/local/bin/validator-bridge

# Deno cache
DENO_DIR=.deno_cache
----

== Performance

WASM acceleration provides significant performance improvements:

[cols="3,2,2,2",options="header"]
|===
|Operation |JavaScript |Native Deno |WASM/Rust

|SHA-256 Hash (10KB)
|~2ms
|~1ms
|~0.4ms

|Normalization (10KB)
|~1ms
|~0.8ms
|~0.5ms

|Batch Hash (1000 docs)
|~2000ms
|~1000ms
|~400ms
|===

== Additional Resources

* *Architecture Docs*: link:docs/doc-reconciliation-architecture.adoc[]
* *Implementation Summary*: link:docs/IMPLEMENTATION-SUMMARY.adoc[]
* *RSR Compliance Audit*: link:docs/RSR-COMPLIANCE-AUDIT.adoc[]
* *TPCF Governance*: link:docs/TPCF.adoc[]
* *ReScript Docs*: https://rescript-lang.org/docs
* *Deno Docs*: https://deno.land/manual
* *ArangoDB Docs*: https://www.arangodb.com/docs
* *Just Manual*: https://just.systems/man

== Notes for Claude

=== Current Focus

Phase 1 MVP is COMPLETE with RSR compliance implemented:

* ✅ Content-addressable deduplication
* ✅ Conflict resolution with confidence scoring
* ✅ ArangoDB graph storage
* ✅ Idempotent pipeline
* ✅ LLM integration with guardrails
* ✅ Logical inference (miniKanren/Datalog)
* ✅ Haskell validation bridge
* ✅ CCCP compliance checking
* ✅ Graph visualization
* ✅ Deno runtime migration
* ✅ WASM acceleration (2-5x performance)
* ✅ Podman containerization
* ✅ RSR framework compliance (Silver tier)
* ✅ TPCF Perimeter 3 governance
* ✅ Comprehensive documentation (AsciiDoc)
* ✅ Dual licensing (MIT + Palimpsest v0.8)

=== Important Constraints

1. *Type Safety*: Never bypass ReScript's type system
2. *Memory Safety*: Rust WASM uses ownership model
3. *Idempotency*: All operations must be rerunnable
4. *LLM Guardrails*: NEVER auto-commit LLM output, always `requiresApproval: true`
5. *Content Hashing*: Use WASM-accelerated SHA-256
6. *Confidence Threshold*: Default 0.9 for auto-resolution
7. *Database*: ArangoDB is multi-model (document + graph)
8. *No Python*: CCCP compliance - recommend ReScript/Deno migrations
9. *RSR Compliance*: Maintain Silver tier (80%+)
10. *Offline-First*: System should work without network

=== Code Patterns to Follow

[source,rescript]
----
// Good: Pattern matching with exhaustiveness
let docType = switch doc.metadata.documentType {
| README => "readme"
| LICENSE => "license"
| SECURITY => "security"
// ... all variants covered
}

// Good: Belt for functional operations
documents->Belt.Array.map(doc => doc.hash)

// Good: Result type for error handling
let result: result<document, string> = ...
switch result {
| Ok(doc) => // handle success
| Error(msg) => // handle error
}

// Good: Confidence scoring
let resolution = {
  confidence: 0.95,
  requiresApproval: false, // Only if > threshold
  ...
}
----

[source,typescript]
----
// Good: Deno imports with version pinning
import { parseArgs } from "@std/cli/parse_args.ts";

// Good: WASM with fallback
export async function hashContent(content: string): Promise<string> {
  if (wasmModule) {
    return wasmModule.hash_content(content);
  }
  return hashContentNative(content); // Fallback
}
----

[source,rust]
----
// Good: WASM optimization
#[wasm_bindgen]
pub fn hash_content(content: &str) -> String {
    let mut hasher = Sha256::new();
    hasher.update(content.as_bytes());
    format!("{:x}", hasher.finalize())
}
----

=== Code Patterns to Avoid

[source,rescript]
----
// Bad: Throwing exceptions (use Result instead)
raise(Js.Exn.raiseError("error"))

// Bad: Mutable state (use immutable by default)
let x = ref(0)

// Bad: Auto-committing LLM output
let llmResponse = {
  requiresApproval: false, // NEVER DO THIS
  ...
}

// Bad: Bypassing type system
%raw(`unsafe.js.code()`)
----

[source,typescript]
----
// Bad: Using npm packages directly (use Deno-compatible)
import express from "express"; // Use Deno's built-in HTTP instead

// Bad: Synchronous file operations
const content = Deno.readTextFileSync(path); // Use async

// Bad: Ignoring WASM errors
await initWasm(); // Should handle errors gracefully
----

=== Testing Strategy

1. *Unit Tests*: Test individual functions in TestRunner.res
2. *Integration Tests*: Test full pipeline with real data
3. *Type Tests*: Rely on ReScript compiler for type safety
4. *WASM Tests*: Verify performance improvements
5. *RSR Compliance*: Run verification script regularly

Before committing:

[source,bash]
----
deno task build              # Ensure compilation
deno task build:wasm         # Build WASM modules
deno task test               # Run all tests
just ci                      # Run full CI checks locally
deno run --allow-read scripts/verify-rsr-compliance.ts
----

=== Critical Invariants

1. *Same hash = same content* - Deduplication guarantee
2. *Confidence > 0.9 = auto-resolve* - Resolution threshold
3. *LLM output requires approval* - Never auto-commit
4. *Canonical source priority* - Explicit > File > Inferred
5. *Idempotent stages* - Can rerun any stage safely
6. *WASM acceleration* - Use for hash/normalize operations
7. *Offline-first* - No network required for core operations
8. *RSR compliance* - Maintain all 11 categories

=== Performance Considerations

* WASM hashing is 2-3x faster than native Deno crypto
* WASM normalization is 1.5-2x faster
* Deduplication is O(n) in document count
* Hash generation is O(m) in content length
* Graph queries are indexed by hash
* Batch database operations when possible
* AOT compilation reduces startup time

== Licensing

This project is dual-licensed:

* *MIT License* - Permissive open source
* *Palimpsest License v0.8* - Experimental reversibility-focused license

Contributors may choose which license to use.

See link:LICENSE.txt[] for full terms.

== Contact

* *Repository*: https://github.com/Hyperpolymath/recon-silly-ation
* *Issues*: https://github.com/Hyperpolymath/recon-silly-ation/issues
* *Security*: security@example.com (see link:.well-known/security.txt[])
* *Maintainer*: Hyperpolymath
* *Contributing*: See link:CONTRIBUTING.adoc[]
* *Code of Conduct*: link:CODE_OF_CONDUCT.md[]
* *Governance*: link:MAINTAINERS.md[]

---

*Last Updated*: 2025-11-22 +
*Project Status*: Phase 1 MVP Complete + RSR Compliant ✅ +
*Compliance Tier*: Silver (80%+)
