# Build automation for recon-silly-ation (Deno + WASM + Podman)
# https://github.com/casey/just

# Default recipe
default:
    @just --list

# Install Deno (if not already installed)
install-deno:
    @if ! command -v deno &> /dev/null; then \
        echo "Installing Deno..."; \
        curl -fsSL https://deno.land/install.sh | sh; \
    else \
        echo "Deno already installed:"; \
        deno --version; \
    fi

# Install Rust (for WASM building)
install-rust:
    @if ! command -v cargo &> /dev/null; then \
        echo "Installing Rust..."; \
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y; \
    else \
        echo "Rust already installed:"; \
        rustc --version; \
    fi

# Cache Deno dependencies
cache:
    deno cache src/main.ts

# Build WASM modules from Rust
build-wasm: install-rust
    deno task build:wasm

# Build everything
build: build-wasm cache
    @echo "✅ Build complete"

# Clean build artifacts
clean:
    rm -rf lib/
    rm -rf wasm-modules/target/
    rm -rf bin/
    rm -f src/wasm/hasher.wasm
    @echo "✅ Cleaned"

# Run the CLI
run *ARGS:
    deno run --allow-all src/main.ts {{ARGS}}

# Scan a repository
scan REPO:
    deno run --allow-all src/main.ts scan --repo {{REPO}}

# Run in daemon mode
daemon REPO INTERVAL="300":
    deno run --allow-all src/main.ts daemon --repo {{REPO}} --interval {{INTERVAL}}

# Compile to AOT binary
compile: build
    deno task compile:aot

# Run tests
test:
    deno task test

# Type check
check:
    deno check src/main.ts

# Lint code
lint:
    deno lint src/ tests/

# Format code
fmt:
    deno fmt src/ tests/ scripts/

# Full development setup
dev-setup: install-deno install-rust build
    @echo "✅ Development environment ready!"

# Podman build
podman-build:
    podman build -t recon-silly-ation:latest -f Containerfile .

# Podman compose up
podman-up:
    podman-compose up

# Full CI check
ci: lint check test
    @echo "✅ CI checks passed!"

# Help
help:
    @echo "recon-silly-ation - Deno + WASM Edition"
    @echo ""
    @echo "  just build            - Build WASM + cache deps"
    @echo "  just scan REPO        - Scan repository"
    @echo "  just compile          - Compile AOT binary"
    @echo "  just test             - Run tests"
    @echo "  just podman-build     - Build container"
    @echo ""
    @echo "Full list: just --list"
